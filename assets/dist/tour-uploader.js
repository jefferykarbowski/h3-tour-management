import{r as c,u as V,j as e,L as P,I as $,m as u,F as G,U as _,B as X,a as k,D as Y,b as K,c as Q,d as Z,e as ee,C as se,P as te,f as ae,R as re}from"./chunks/index-B1xDN1qa.js";const oe={initial:{x:0,y:0},animate:{x:20,y:-20,opacity:.9}},ne={initial:{opacity:0},animate:{opacity:1}};function le(){return e.jsx("div",{className:"flex bg-gray-100 dark:bg-neutral-900 flex-shrink-0 flex-wrap justify-center items-center gap-x-px gap-y-px scale-105",children:Array.from({length:11}).map((h,g)=>Array.from({length:41}).map((w,r)=>{const f=g*41+r;return e.jsx("div",{className:`w-10 h-10 flex flex-shrink-0 rounded-[2px] ${f%2===0?"bg-gray-50 dark:bg-neutral-950":"bg-gray-50 dark:bg-neutral-950 shadow-[0px_0px_1px_3px_rgba(255,255,255,1)_inset] dark:shadow-[0px_0px_1px_3px_rgba(0,0,0,1)_inset]"}`},`${r}-${g}`)}))})}function ie({onUploadComplete:x}){const[i,h]=c.useState(""),[g,w]=c.useState("index.htm"),[r,f]=c.useState(null),[N,v]=c.useState(!1),[S,m]=c.useState(0),[b,U]=c.useState(!1),[j,E]=c.useState("uploading"),[L,T]=c.useState(0),C=c.useRef(null),F=s=>{if(s.length>0){const o=s[0];o.name.endsWith(".zip")&&f(o)}},R=()=>{var s;(s=C.current)==null||s.click()},{getRootProps:I,isDragActive:A}=V({multiple:!1,noClick:!0,accept:{"application/zip":[".zip"]},onDrop:F}),M=async()=>{if(!(!i||!r)){v(!0),m(0),E("uploading"),T(0);try{const s=await H(r,i,g),o=s.tour_id;if(!o)throw new Error("Server did not return tour_id");await O(r,s),await B(i),await W(o),m(100),U(!0),setTimeout(()=>{v(!1),U(!1),x==null||x(i,r),h(""),w("index.htm"),f(null),m(0)},1500)}catch(s){console.error("Upload error:",s),v(!1),m(0),alert(`Upload failed: ${s instanceof Error?s.message:"Unknown error"}`)}}},H=async(s,o,d)=>{var p,y,z;const a=new FormData;a.append("action","h3tm_get_s3_presigned_url"),a.append("tour_name",o),a.append("entry_file",d),a.append("file_name",s.name),a.append("file_size",s.size.toString()),a.append("file_type",s.type||"application/zip"),a.append("nonce",((p=window.h3tm_ajax)==null?void 0:p.nonce)||"");const t=await fetch(((y=window.h3tm_ajax)==null?void 0:y.ajax_url)||"/wp-admin/admin-ajax.php",{method:"POST",body:a});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const l=await t.text();console.log("Presigned URL response:",l);let n;try{n=JSON.parse(l)}catch(J){throw console.error("JSON parse error:",J),console.error("Response text:",l),new Error(`Invalid JSON response: ${l.substring(0,200)}`)}if(!n.success)throw new Error(((z=n.data)==null?void 0:z.message)||n.data||"Failed to get upload URL");return n.data},O=async(s,o)=>new Promise((d,a)=>{const t=new XMLHttpRequest;t.upload.addEventListener("progress",n=>{if(n.lengthComputable){const p=Math.round(n.loaded/n.total*100);m(p)}}),t.addEventListener("load",()=>{t.status>=200&&t.status<300?d():a(new Error(`S3 upload failed: ${t.status} ${t.statusText}`))}),t.addEventListener("error",()=>{a(new Error("Network error during upload"))}),t.addEventListener("abort",()=>{a(new Error("Upload cancelled"))}),t.open("PUT",o.upload_url),t.timeout=3e5;const l=s.type||"application/zip";t.setRequestHeader("Content-Type",l),t.send(s)}),B=async s=>{var t,l;const o=new FormData;o.append("action","h3tm_mark_tour_processing"),o.append("tour_name",s),o.append("nonce",((t=window.h3tm_ajax)==null?void 0:t.nonce)||"");const d=await fetch(((l=window.h3tm_ajax)==null?void 0:l.ajax_url)||"/wp-admin/admin-ajax.php",{method:"POST",body:o});if(!d.ok)throw new Error(`HTTP ${d.status}: ${d.statusText}`);const a=await d.json();a.success||console.log("Failed to mark as processing:",a.data)},W=async s=>{const a=`/h3panos/${s}/index.htm`;console.log("ðŸ”„ Starting Lambda processing status monitor for tour_id:",s),console.log("Testing URL:",a),E("processing"),m(0),T(0);for(let t=1;t<=60;t++){console.log(`ðŸ” Polling attempt ${t}/60`);try{const n=new AbortController,p=setTimeout(()=>n.abort(),5e3),y=await fetch(a,{method:"HEAD",signal:n.signal});if(clearTimeout(p),y.ok){console.log("âœ… Tour is ready!"),m(100);return}}catch{console.log(`Tour not ready yet (attempt ${t}/60)`)}T(t*5);const l=Math.min(95,Math.round(t/60*100));m(l),t<60&&await new Promise(n=>setTimeout(n,5e3))}throw console.log("â±ï¸ Processing timeout - tour taking longer than expected"),new Error("Processing timeout - tour taking longer than expected. The tour should appear shortly.")},q=i.trim()!==""&&r!==null;return e.jsxs("div",{className:"w-full max-w-2xl p-6 space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h2",{className:"text-2xl font-semibold tracking-tight",children:"Upload 3D Tour"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Upload your 3D tour .zip file and provide a name for your tour"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"tour-name",className:"text-sm font-medium",children:"Tour Name"}),e.jsx($,{id:"tour-name",placeholder:"Enter tour name...",value:i,onChange:s=>h(s.target.value),className:"w-full"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(P,{htmlFor:"entry-file",className:"text-sm font-medium",children:["Entry File ",e.jsx("span",{className:"text-muted-foreground font-normal",children:"(optional)"})]}),e.jsx($,{id:"entry-file",placeholder:"index.htm",value:g,onChange:s=>w(s.target.value||"index.htm"),className:"w-full"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Default: index.htm. Change if your tour uses a different entry point (e.g., index.html, Mellott.html)"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{className:"text-sm font-medium",children:"Tour File (.zip)"}),e.jsx("div",{className:"border-2 border-dashed rounded-lg bg-background hover:bg-accent/5 transition-colors",...I(),children:e.jsxs(u.div,{onClick:R,whileHover:"animate",className:"p-8 cursor-pointer w-full relative overflow-hidden",children:[e.jsx("input",{ref:C,id:"file-upload-handle",type:"file",accept:".zip",onChange:s=>F(Array.from(s.target.files||[])),className:"hidden"}),e.jsx("div",{className:"absolute inset-0 [mask-image:radial-gradient(ellipse_at_center,white,transparent)]",children:e.jsx(le,{})}),e.jsxs("div",{className:"flex flex-col items-center justify-center relative z-10",children:[e.jsx("div",{className:"relative w-full max-w-xl mx-auto",children:r?e.jsx(u.div,{layoutId:"file-upload",className:"relative overflow-hidden z-40 bg-card border border-border flex flex-col items-start justify-start p-4 w-full mx-auto rounded-md shadow-sm",children:e.jsxs("div",{className:"flex justify-between w-full items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(G,{className:"h-5 w-5 text-blue-500"}),e.jsx(u.p,{initial:{opacity:0},animate:{opacity:1},className:"text-sm font-medium text-foreground truncate max-w-xs",children:r.name})]}),e.jsxs(u.p,{initial:{opacity:0},animate:{opacity:1},className:"rounded-md px-2 py-1 text-xs bg-blue-500/10 text-blue-600 dark:text-blue-400",children:[(r.size/(1024*1024)).toFixed(2)," MB"]})]})}):e.jsxs(e.Fragment,{children:[e.jsx(u.div,{layoutId:"file-upload",variants:oe,transition:{type:"spring",stiffness:300,damping:20},className:"relative group-hover/file:shadow-lg z-40 bg-card border border-border flex items-center justify-center h-32 w-full max-w-[8rem] mx-auto rounded-md transition-shadow",children:A?e.jsxs(u.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col items-center text-blue-500",children:[e.jsx("span",{className:"text-xs mb-1",children:"Drop it"}),e.jsx(_,{className:"h-5 w-5"})]}):e.jsx(_,{className:"h-5 w-5 text-muted-foreground"})}),e.jsx(u.div,{variants:ne,className:"absolute opacity-0 border-2 border-dashed border-blue-400 inset-0 z-30 bg-transparent flex items-center justify-center h-32 w-full max-w-[8rem] mx-auto rounded-md"})]})}),!r&&e.jsxs("div",{className:"mt-4 text-center",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:"Upload .zip file"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Drag and drop or click to browse"})]})]})]})})]}),e.jsx(X,{onClick:M,disabled:!q||N,className:"w-full bg-blue-600 hover:bg-blue-700 text-white",children:N?e.jsxs(e.Fragment,{children:[e.jsx(k,{className:"mr-2 h-4 w-4 animate-spin"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"mr-2 h-4 w-4"}),"Upload Tour"]})})]}),e.jsx(Y,{open:N,onOpenChange:()=>{},children:e.jsxs(K,{className:"sm:max-w-md",children:[e.jsxs(Q,{children:[e.jsx(Z,{children:b?"Upload Complete!":j==="uploading"?"Uploading to S3":"Processing Tour"}),e.jsx(ee,{children:b?"Your 3D tour has been uploaded and processed successfully.":j==="uploading"?"Uploading your 3D tour file to AWS S3...":`AWS Lambda is extracting and deploying your tour... (${L} seconds elapsed)`})]}),e.jsx("div",{className:"space-y-4 py-4",children:b?e.jsxs("div",{className:"flex flex-col items-center justify-center py-6",children:[e.jsx(u.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:200,damping:15},children:e.jsx(se,{className:"h-16 w-16 text-green-500"})}),e.jsx("p",{className:"mt-4 text-sm font-medium",children:i})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:j==="uploading"?"Upload Progress":"Processing Progress"}),e.jsxs("span",{className:"font-medium text-blue-600",children:[S,"%"]})]}),e.jsx(te,{value:S,className:"h-2"})]}),j==="uploading"?e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(k,{className:"h-4 w-4 animate-spin text-blue-500"}),e.jsxs("span",{children:["Uploading ",r==null?void 0:r.name,"..."]})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(k,{className:"h-4 w-4 animate-spin text-blue-500"}),e.jsx("span",{children:"Processing tour on AWS Lambda..."})]}),e.jsxs("div",{className:"pl-6 space-y-1 text-xs text-muted-foreground",children:[e.jsx("div",{children:"â€¢ Downloading from S3"}),e.jsx("div",{children:"â€¢ Extracting tour files"}),e.jsx("div",{children:"â€¢ Injecting analytics"}),e.jsx("div",{children:"â€¢ Deploying to tours directory"})]}),e.jsx("p",{className:"text-xs text-muted-foreground italic",children:"This may take 2-5 minutes for large tours. Please wait..."})]})]})})]})})]})}console.log("Tour Uploader script loaded");const D=document.getElementById("h3tm-tour-uploader-root");console.log("Looking for uploader container:",D);D?(console.log("Mounting Tour Uploader component"),ae(D).render(e.jsx(re.StrictMode,{children:e.jsx(ie,{onUploadComplete:(i,h)=>{console.log("Tour uploaded successfully:",i,h),setTimeout(()=>{window.location.reload()},1e3)}})})),console.log("Tour Uploader mounted successfully")):console.error("Could not find h3tm-tour-uploader-root container!");
