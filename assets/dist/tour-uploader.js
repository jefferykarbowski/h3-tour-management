import{r as m,u as B,j as e,L as E,I as W,m as u,F as q,U as v,B as J,a as T,D as V,b as G,c as X,d as Y,e as K,C as Q,P as Z,f as ee,R as se}from"./chunks/index-B1xDN1qa.js";const te={initial:{x:0,y:0},animate:{x:20,y:-20,opacity:.9}},ae={initial:{opacity:0},animate:{opacity:1}};function re(){return e.jsx("div",{className:"flex bg-gray-100 dark:bg-neutral-900 flex-shrink-0 flex-wrap justify-center items-center gap-x-px gap-y-px scale-105",children:Array.from({length:11}).map((h,a)=>Array.from({length:41}).map((y,p)=>{const f=a*41+p;return e.jsx("div",{className:`w-10 h-10 flex flex-shrink-0 rounded-[2px] ${f%2===0?"bg-gray-50 dark:bg-neutral-950":"bg-gray-50 dark:bg-neutral-950 shadow-[0px_0px_1px_3px_rgba(255,255,255,1)_inset] dark:shadow-[0px_0px_1px_3px_rgba(0,0,0,1)_inset]"}`},`${p}-${a}`)}))})}function oe({onUploadComplete:g}){const[c,h]=m.useState(""),[a,y]=m.useState(null),[p,f]=m.useState(!1),[_,d]=m.useState(0),[b,k]=m.useState(!1),[j,D]=m.useState("uploading"),[C,N]=m.useState(0),S=m.useRef(null),U=s=>{if(s.length>0){const r=s[0];r.name.endsWith(".zip")&&y(r)}},z=()=>{var s;(s=S.current)==null||s.click()},{getRootProps:$,isDragActive:F}=B({multiple:!1,noClick:!0,accept:{"application/zip":[".zip"]},onDrop:U}),L=async()=>{if(!(!c||!a)){f(!0),d(0),D("uploading"),N(0);try{const s=await R(a,c),r=s.tour_id;if(!r)throw new Error("Server did not return tour_id");await I(a,s),await A(c),await H(r),d(100),k(!0),setTimeout(()=>{f(!1),k(!1),g==null||g(c,a),h(""),y(null),d(0)},1500)}catch(s){console.error("Upload error:",s),f(!1),d(0),alert(`Upload failed: ${s instanceof Error?s.message:"Unknown error"}`)}}},R=async(s,r)=>{var i,x,w;const o=new FormData;o.append("action","h3tm_get_s3_presigned_url"),o.append("tour_name",r),o.append("file_name",s.name),o.append("file_size",s.size.toString()),o.append("file_type",s.type||"application/zip"),o.append("nonce",((i=window.h3tm_ajax)==null?void 0:i.nonce)||"");const n=await fetch(((x=window.h3tm_ajax)==null?void 0:x.ajax_url)||"/wp-admin/admin-ajax.php",{method:"POST",body:o});if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const t=await n.text();console.log("Presigned URL response:",t);let l;try{l=JSON.parse(t)}catch(O){throw console.error("JSON parse error:",O),console.error("Response text:",t),new Error(`Invalid JSON response: ${t.substring(0,200)}`)}if(!l.success)throw new Error(((w=l.data)==null?void 0:w.message)||l.data||"Failed to get upload URL");return l.data},I=async(s,r)=>new Promise((o,n)=>{const t=new XMLHttpRequest;t.upload.addEventListener("progress",i=>{if(i.lengthComputable){const x=Math.round(i.loaded/i.total*100);d(x)}}),t.addEventListener("load",()=>{t.status>=200&&t.status<300?o():n(new Error(`S3 upload failed: ${t.status} ${t.statusText}`))}),t.addEventListener("error",()=>{n(new Error("Network error during upload"))}),t.addEventListener("abort",()=>{n(new Error("Upload cancelled"))}),t.open("PUT",r.upload_url),t.timeout=3e5;const l=s.type||"application/zip";t.setRequestHeader("Content-Type",l),t.send(s)}),A=async s=>{var t,l;const r=new FormData;r.append("action","h3tm_mark_tour_processing"),r.append("tour_name",s),r.append("nonce",((t=window.h3tm_ajax)==null?void 0:t.nonce)||"");const o=await fetch(((l=window.h3tm_ajax)==null?void 0:l.ajax_url)||"/wp-admin/admin-ajax.php",{method:"POST",body:r});if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);const n=await o.json();n.success||console.log("Failed to mark as processing:",n.data)},H=async s=>{const n=`/h3panos/${s}/index.htm`;console.log("ðŸ”„ Starting Lambda processing status monitor for tour_id:",s),console.log("Testing URL:",n),D("processing"),d(0),N(0);for(let t=1;t<=60;t++){console.log(`ðŸ” Polling attempt ${t}/60`);try{const i=new AbortController,x=setTimeout(()=>i.abort(),5e3),w=await fetch(n,{method:"HEAD",signal:i.signal});if(clearTimeout(x),w.ok){console.log("âœ… Tour is ready!"),d(100);return}}catch{console.log(`Tour not ready yet (attempt ${t}/60)`)}N(t*5);const l=Math.min(95,Math.round(t/60*100));d(l),t<60&&await new Promise(i=>setTimeout(i,5e3))}throw console.log("â±ï¸ Processing timeout - tour taking longer than expected"),new Error("Processing timeout - tour taking longer than expected. The tour should appear shortly.")},M=c.trim()!==""&&a!==null;return e.jsxs("div",{className:"w-full max-w-2xl p-6 space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h2",{className:"text-2xl font-semibold tracking-tight",children:"Upload 3D Tour"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Upload your 3D tour .zip file and provide a name for your tour"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"tour-name",className:"text-sm font-medium",children:"Tour Name"}),e.jsx(W,{id:"tour-name",placeholder:"Enter tour name...",value:c,onChange:s=>h(s.target.value),className:"w-full"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{className:"text-sm font-medium",children:"Tour File (.zip)"}),e.jsx("div",{className:"border-2 border-dashed rounded-lg bg-background hover:bg-accent/5 transition-colors",...$(),children:e.jsxs(u.div,{onClick:z,whileHover:"animate",className:"p-8 cursor-pointer w-full relative overflow-hidden",children:[e.jsx("input",{ref:S,id:"file-upload-handle",type:"file",accept:".zip",onChange:s=>U(Array.from(s.target.files||[])),className:"hidden"}),e.jsx("div",{className:"absolute inset-0 [mask-image:radial-gradient(ellipse_at_center,white,transparent)]",children:e.jsx(re,{})}),e.jsxs("div",{className:"flex flex-col items-center justify-center relative z-10",children:[e.jsx("div",{className:"relative w-full max-w-xl mx-auto",children:a?e.jsx(u.div,{layoutId:"file-upload",className:"relative overflow-hidden z-40 bg-card border border-border flex flex-col items-start justify-start p-4 w-full mx-auto rounded-md shadow-sm",children:e.jsxs("div",{className:"flex justify-between w-full items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(q,{className:"h-5 w-5 text-blue-500"}),e.jsx(u.p,{initial:{opacity:0},animate:{opacity:1},className:"text-sm font-medium text-foreground truncate max-w-xs",children:a.name})]}),e.jsxs(u.p,{initial:{opacity:0},animate:{opacity:1},className:"rounded-md px-2 py-1 text-xs bg-blue-500/10 text-blue-600 dark:text-blue-400",children:[(a.size/(1024*1024)).toFixed(2)," MB"]})]})}):e.jsxs(e.Fragment,{children:[e.jsx(u.div,{layoutId:"file-upload",variants:te,transition:{type:"spring",stiffness:300,damping:20},className:"relative group-hover/file:shadow-lg z-40 bg-card border border-border flex items-center justify-center h-32 w-full max-w-[8rem] mx-auto rounded-md transition-shadow",children:F?e.jsxs(u.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col items-center text-blue-500",children:[e.jsx("span",{className:"text-xs mb-1",children:"Drop it"}),e.jsx(v,{className:"h-5 w-5"})]}):e.jsx(v,{className:"h-5 w-5 text-muted-foreground"})}),e.jsx(u.div,{variants:ae,className:"absolute opacity-0 border-2 border-dashed border-blue-400 inset-0 z-30 bg-transparent flex items-center justify-center h-32 w-full max-w-[8rem] mx-auto rounded-md"})]})}),!a&&e.jsxs("div",{className:"mt-4 text-center",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:"Upload .zip file"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Drag and drop or click to browse"})]})]})]})})]}),e.jsx(J,{onClick:L,disabled:!M||p,className:"w-full bg-blue-600 hover:bg-blue-700 text-white",children:p?e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"mr-2 h-4 w-4 animate-spin"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(v,{className:"mr-2 h-4 w-4"}),"Upload Tour"]})})]}),e.jsx(V,{open:p,onOpenChange:()=>{},children:e.jsxs(G,{className:"sm:max-w-md",children:[e.jsxs(X,{children:[e.jsx(Y,{children:b?"Upload Complete!":j==="uploading"?"Uploading to S3":"Processing Tour"}),e.jsx(K,{children:b?"Your 3D tour has been uploaded and processed successfully.":j==="uploading"?"Uploading your 3D tour file to AWS S3...":`AWS Lambda is extracting and deploying your tour... (${C} seconds elapsed)`})]}),e.jsx("div",{className:"space-y-4 py-4",children:b?e.jsxs("div",{className:"flex flex-col items-center justify-center py-6",children:[e.jsx(u.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:200,damping:15},children:e.jsx(Q,{className:"h-16 w-16 text-green-500"})}),e.jsx("p",{className:"mt-4 text-sm font-medium",children:c})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:j==="uploading"?"Upload Progress":"Processing Progress"}),e.jsxs("span",{className:"font-medium text-blue-600",children:[_,"%"]})]}),e.jsx(Z,{value:_,className:"h-2"})]}),j==="uploading"?e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(T,{className:"h-4 w-4 animate-spin text-blue-500"}),e.jsxs("span",{children:["Uploading ",a==null?void 0:a.name,"..."]})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(T,{className:"h-4 w-4 animate-spin text-blue-500"}),e.jsx("span",{children:"Processing tour on AWS Lambda..."})]}),e.jsxs("div",{className:"pl-6 space-y-1 text-xs text-muted-foreground",children:[e.jsx("div",{children:"â€¢ Downloading from S3"}),e.jsx("div",{children:"â€¢ Extracting tour files"}),e.jsx("div",{children:"â€¢ Injecting analytics"}),e.jsx("div",{children:"â€¢ Deploying to tours directory"})]}),e.jsx("p",{className:"text-xs text-muted-foreground italic",children:"This may take 2-5 minutes for large tours. Please wait..."})]})]})})]})})]})}console.log("Tour Uploader script loaded");const P=document.getElementById("h3tm-tour-uploader-root");console.log("Looking for uploader container:",P);P?(console.log("Mounting Tour Uploader component"),ee(P).render(e.jsx(se.StrictMode,{children:e.jsx(oe,{onUploadComplete:(c,h)=>{console.log("Tour uploaded successfully:",c,h),setTimeout(()=>{window.location.reload()},1e3)}})})),console.log("Tour Uploader mounted successfully")):console.error("Could not find h3tm-tour-uploader-root container!");
