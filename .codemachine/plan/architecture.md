# System Architecture Blueprint: H3 Tour Management Plugin Revamp

**Version:** 1.0
**Date:** 2025-10-09
**Generated By:** OpenAI Codex CLI Agent

## 1. Introduction & Goals

* **1.1. Project Vision:** Deliver a stable, maintainable, and modernized WordPress plugin for managing 3D tours hosted on AWS S3/CloudFront with Lambda processing. Resolve critical functional bugs, refactor the codebase into clear, testable units, and improve the admin UX for efficient tour management at scale.
* **1.2. Key Objectives:**
  - Fix critical defects: Delete, Change URL, Rename, Update, Get Script, Rebuild Metadata
  - Enforce S3 path correctness using metadata as the source of truth
  - Add robust logging, diagnostics, and testability
  - Refactor `H3TM_Admin` into traits for maintainability and clear separation of concerns
  - Modernize admin UX: search/filter, bulk actions, progress feedback, confirmations
  - Preserve backward compatibility and data integrity (URL redirects, metadata)
  - Secure AWS interactions (least privilege, signed URLs) and protect WP admin (nonces, capability checks)
* **1.3. Scope:**
  - In: WordPress plugin codebase (PHP 7.4+), admin JS (jQuery), MySQL schema, AWS S3/CloudFront/Lambda integration, logging, redirects, refactoring to traits, UX improvements within WP Admin.
  - Out: Public website theming, non-admin front-end redesign, non-AWS storage backends, full CI/CD pipeline (recommended, not mandatory), third-party analytics beyond basic hooks.
* **1.4. Key Assumptions:**
  - WordPress 5.8+ environment with standard hosting (Apache/Nginx + PHP-FPM) and access to PHP 7.4+.
  - AWS credentials configured with least-privilege access to S3 and CloudFront invalidation; Lambda already processes uploads and writes status into S3.
  - CloudFront fronts the S3 bucket for public tour delivery; admin-side AWS calls should bypass CDN caching where needed.
  - Existing DB table `wp_h3tm_tour_metadata` exists and stores canonical `s3_folder` (with spaces) and URL history JSON.

## 2. Architectural Drivers

* **2.1. Functional Requirements Summary:**
  - Manage tours (list, preview, embed, update, rename, change URL, archive/delete).
  - Use metadata.s3_folder as canonical path for all S3 operations.
  - Provide AJAX-based admin interactions with robust feedback and logging.
  - Maintain URL history and 301 redirects after slug changes.
  - Rebuild metadata and support migration/processing flows with AWS services.
* **2.2. Non-Functional Requirements (NFRs):**
  - Maintainability: Trait-based decomposition; smaller files/modules; clear boundaries.
  - Reliability: Correct S3 path handling; idempotent operations; error handling/logging.
  - Usability: Search/filter, bulk actions, progress feedback, confirmations.
  - Security: WP capability checks, nonces, sanitization/escaping, least-privilege IAM; secure secrets storage.
  - Performance: Efficient S3 operations; minimal blocking in admin; optional polling for status; avoid unnecessary CloudFront cache misses.
  - Compatibility: PHP 7.4+, WordPress 5.8+; jQuery-based admin.
* **2.3. Constraints & Preferences:**
  - Stack locked to WordPress/PHP/MySQL and AWS (S3/CloudFront/Lambda) per current solution.
  - Prefer minimal invasive changes to Lambda; WordPress adapts to preserve folder spaces.
  - Admin JS remains jQuery; optional incremental improvements without full SPA rewrite.

## 3. Proposed Architecture

* **3.1. Architectural Style:**
  - Layered WordPress plugin (modular monolith) integrated with serverless components (AWS Lambda). Internal modularization via PHP traits and clear component boundaries (Admin controllers, Data Access, S3 client, Redirector). Admin UI uses progressive enhancement with jQuery and AJAX (WP admin-ajax and/or REST API).

* **3.2. Technology Stack Summary:**
  - Frontend: WordPress Admin UI + jQuery (no SPA); optional CSS enhancements.
  - Backend Language/Framework: PHP 7.4+ WordPress plugin APIs; optional PSR-4 autoload via Composer (future).
  - Database: MySQL (WordPress DB), table `wp_h3tm_tour_metadata` as specified.
  - Messaging/Queues: None directly; Lambda asynchronous processing handles uploads; optional S3 status object for polling.
  - Cloud Platform/Services: AWS S3 (storage), CloudFront (CDN), Lambda (ZIP processing), optional CloudWatch logs.
  - Containerization/Orchestration: None required (WordPress hosting). Serverless for Lambda.
  - Key Libraries/Tools: AWS SDK for PHP (S3/CloudFront), WP nonces & capability checks, PSR-3-compatible logging wrapper (optional; fallback to `error_log`).

* **3.3. System Context Diagram (C4 Level 1):**
  - **Description:** The H3 Tour Management Plugin operates inside WordPress Admin. Admin users manage tours that are stored in S3 and served to site visitors via CloudFront. Lambda processes uploads and writes status. Metadata persists in MySQL; redirects are handled within WordPress based on URL history.
  - **Diagram (PlantUML):**
    ~~~plantuml
    @startuml
    !include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml

    Person(admin, "WP Admin User", "Manages 3D tours via WP Admin")
    Person(visitor, "Site Visitor", "Views embedded/linked tours")

    System_Boundary(h3tm_sys, "H3 Tour Management Plugin (WordPress)") {
      System(h3tm, "H3TM Plugin", "Admin UI, S3 ops, metadata, redirects")
    }

    SystemDb(mysql, "WordPress MySQL DB", "Stores tour metadata and URL history")
    System_Ext(s3, "AWS S3", "Stores tour files and status.json")
    System_Ext(cf, "AWS CloudFront", "CDN delivering tour assets")
    System_Ext(lambda, "AWS Lambda", "Processes uploads and updates status")

    Rel(admin, h3tm, "Manages tours", "HTTPS / WP Admin")
    Rel(h3tm, mysql, "Read/Write metadata", "SQL (WordPress DB)")
    Rel(h3tm, s3, "Upload/Download, list, delete", "AWS SDK")
    Rel(h3tm, cf, "Invalidate cache (on update)", "AWS SDK")
    Rel(lambda, s3, "Writes processed files & status", "S3 API")
    Rel(visitor, cf, "Fetches tours", "HTTPS")
    @enduml
    ~~~

* **3.4. Container Diagram (C4 Level 2):**
  - **Description:** Within the system, the plugin comprises PHP admin controllers (AJAX handlers), data access (metadata), S3 client utilities, redirector logic, and admin JS. External containers include MySQL, S3, CloudFront, and Lambda.
  - **Diagram (PlantUML):**
    ~~~plantuml
    @startuml
    !include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

    Person(admin, "WP Admin User")
    Person(visitor, "Site Visitor")

    System_Boundary(h3tm_sys, "H3 Tour Management Plugin (WordPress)") {
      Container(wp, "WordPress Core", "PHP 7.4+", "Plugin host and admin framework")
      Container(h3tm_php, "H3TM PHP Core", "PHP", "Admin controllers, traits, S3 ops, redirects")
      Container(js_admin, "Admin JS", "jQuery", "Modals, AJAX, progress UI")
      ContainerDb(db, "MySQL", "WordPress DB", "wp_h3tm_tour_metadata")
    }

    System_Ext(s3, "AWS S3", "Tour storage + status.json")
    System_Ext(cf, "CloudFront", "CDN")
    System_Ext(lambda, "AWS Lambda", "ZIP processing")

    Rel(admin, js_admin, "Uses", "HTTPS")
    Rel(js_admin, h3tm_php, "AJAX (admin-ajax.php / REST)", "HTTPS/JSON")
    Rel(h3tm_php, db, "RW metadata", "SQL")
    Rel(h3tm_php, s3, "S3 operations (signed URLs, list, delete)", "AWS SDK")
    Rel(h3tm_php, cf, "Cache invalidation", "AWS SDK")
    Rel(lambda, s3, "Write processed files + status", "S3 API")
    Rel(visitor, cf, "Requests tour assets", "HTTPS")
    @enduml
    ~~~

* **3.5. Component Diagram(s) (C4 Level 3):**
  - **Description:** Components inside the H3TM PHP Core container, showing trait-based decomposition and key classes.
  - **Diagram (PlantUML):**
    ~~~plantuml
    @startuml
    !include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

    Container(h3tm_php, "H3TM PHP Core", "PHP") {
      Component(admin_class, "H3TM_Admin", "WP Admin Controller", "Registers hooks, enqueues JS, wires actions")
      Component(trait_tour, "Trait: Tour Handlers", "PHP", "update/get script/change URL/rebuild metadata")
      Component(trait_delren, "Trait: Delete & Rename", "PHP", "Deletion and rename handlers")
      Component(trait_s3, "Trait: S3 Operations", "PHP", "Presigned URLs, uploads, downloads, cleanup")
      Component(trait_mig, "Trait: Migration", "PHP", "Migrate tours to S3, directory upload/delete")
      Component(trait_pages, "Trait: Page Renderers", "PHP", "Render admin pages and UI")
      Component(dao_meta, "H3TM_Tour_Metadata", "PHP", "CRUD for wp_h3tm_tour_metadata; slug history")
      Component(s3_client, "H3TM_S3_Simple", "PHP", "S3 helper using AWS SDK")
      Component(redirector, "H3TM_URL_Redirector", "PHP", "301 redirects based on url_history")
      Component(activator, "H3TM_Activator", "PHP", "DB setup + migrations preserving spaces")
    }

    Rel(admin_class, trait_tour, "uses")
    Rel(admin_class, trait_delren, "uses")
    Rel(admin_class, trait_s3, "uses")
    Rel(admin_class, trait_mig, "uses")
    Rel(admin_class, trait_pages, "uses")
    Rel(trait_tour, dao_meta, "CRUD + slug change")
    Rel(trait_delren, dao_meta, "Lookup by display name/slug")
    Rel(trait_delren, s3_client, "Archive/Delete using s3_folder")
    Rel(trait_s3, s3_client, "Delegates S3 ops")
    Rel(redirector, dao_meta, "Reads url_history")
    Rel(activator, dao_meta, "Initializes schema & migration")
    @enduml
    ~~~

* **3.6. Data Model Overview & ERD:**
  - **Description:** The primary entity is TourMetadata. It stores canonical `tour_slug` (current URL slug), `display_name`, canonical `s3_folder` (must preserve spaces; source of truth for S3 ops), and `url_history` (JSON array of old slugs) for 301 redirects.
  - **Key Entities:** TourMetadata (core), WordPress Options (plugin settings; AWS keys/regions), optionally Log entries (file-based, not a table).
  - **Diagram (PlantUML ERD):**
    ~~~plantuml
    @startuml
    entity TourMetadata {
      *id : bigint <<PK>>
      --
      tour_slug : varchar <<UNIQUE>>
      display_name : varchar
      s3_folder : varchar
      url_history : text  // JSON array of old slugs
      created_date : datetime
      updated_date : datetime
    }

    note right of TourMetadata
      - s3_folder preserves spaces (e.g., "tours/Jeffs Test/")
      - url_history holds previous slugs for redirects
    end note
    @enduml
    ~~~

* **3.7. API Design & Communication:**
  - **API Style:** WordPress admin-ajax (action-based) for admin operations; optional WP REST API endpoints for future extensibility. S3 access via AWS SDK in PHP. Frontend JS uses jQuery AJAX.
  - **Communication Patterns:** Synchronous request/response for admin actions (rename, change URL, delete). Asynchronous processing with Lambda for uploads; progress polled by admin JS via plugin endpoint reading `status.json` from S3 with cache-bypass.
  - **Key Interaction Flow (Sequence Diagram - Delete Tour):**
    - **Description:** Admin deletes a tour. Plugin looks up metadata, uses `s3_folder` as canonical path, deletes or archives S3 contents, updates DB, and refreshes the UI.
    - **Diagram (PlantUML):**
      ~~~plantuml
      @startuml
      actor Admin
      participant "Admin JS (jQuery)" as JS
      participant "H3TM_Admin (PHP)" as PHP
      participant "H3TM_Tour_Metadata" as DAO
      participant "H3TM_S3_Simple" as S3
      database "MySQL" as DB

      Admin -> JS : Click Delete
      JS -> PHP : POST action=h3tm_delete_tour (nonce, display_name or id)
      PHP -> DAO : get_by_display_name(name) or get_by_id(id)
      DAO -> DB : SELECT ...
      DB --> DAO : metadata (includes s3_folder)
      DAO --> PHP : Tour record
      PHP -> S3 : delete/archive using s3_folder
      S3 --> PHP : result (success/err)
      alt success
        PHP -> DB : DELETE FROM wp_h3tm_tour_metadata WHERE id=?
        DB --> PHP : ok
        PHP --> JS : { success: true }
        JS -> Admin : Refresh table / show toast
      else error
        PHP --> JS : { success:false, message }
        JS -> Admin : Show error
      end
      @enduml
      ~~~

* **3.8. Cross-Cutting Concerns:**
  - **Authentication & Authorization:**
    - Enforce `current_user_can('manage_options')` (or plugin-specific capability) on all admin actions.
    - Validate WP nonces on AJAX; rate-limit sensitive operations if needed.
  - **Logging & Monitoring:**
    - Centralized helper (PSR-3-like) to log to `error_log` and optional per-plugin log file (with rotation).
    - Add structured log context for S3 ops (bucket, s3_folder, action, request id) and DB changes (tour id/slug).
    - Lambda logs in CloudWatch; correlate via operation ids where possible.
  - **Security Considerations:**
    - Sanitize/validate all inputs; escape all outputs in admin.
    - Use least-privilege IAM for S3 (restrict to target bucket/prefix) and CloudFront invalidation.
    - Avoid storing AWS secrets in DB; prefer wp-config constants or environment variables. If stored in options, encrypt at rest or document risk.
    - Use presigned URLs for browser uploads; enforce content-type and object key prefixes.
  - **Scalability & Performance:**
    - Keep PHP handlers stateless; offload heavy work to Lambda.
    - Poll for status via lightweight calls; set S3 `status.json` with `Cache-Control: no-store`.
    - Batch operations for bulk actions; paginate tour list; index DB columns (slug, s3_folder).
  - **Reliability & Availability:**
    - Defensive coding and retries for S3 operations (transient failures).
    - Idempotent handlers (e.g., multiple deletes safe if folder missing).
    - CloudFront invalidation only when needed; exponential backoff on API errors.

* **3.9. Deployment View:**
  - **Target Environment:** WordPress site (shared/VPS/cloud) + AWS (S3, CloudFront, Lambda).
  - **Deployment Strategy:** Standard WP plugin packaging. Lambda deployed separately with IaC (SAM/CDK/Terraform optional). AWS SDK configured via environment or constants.
  - **Deployment Diagram (PlantUML):**
    ~~~plantuml
    @startuml
    !include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Deployment.puml

    deploymentNode("WP Host", "WordPress Server", "Apache/Nginx + PHP-FPM") {
      node wp_core <<WP>> {
        container(h3tm_plugin, "H3TM Plugin", "PHP + jQuery")
      }
      deploymentNode(dbnode, "MySQL", "RDBMS") {
        database(h3tm_db, "wp_h3tm_tour_metadata", "MySQL")
      }
    }

    deploymentNode("AWS", "AWS Region", "us-east-1") {
      node s3 <<S3 Bucket>>
      node cf <<CloudFront>>
      node lambda <<Lambda>>
    }

    Rel(h3tm_plugin, s3, "S3 API via AWS SDK")
    Rel(h3tm_plugin, cf, "Invalidate cache")
    Rel(lambda, s3, "Write processed tours & status")
    Rel(visitor, cf, "Serve tours", "HTTPS")
    @enduml
    ~~~

## 4. Design Rationale & Trade-offs

* **4.1. Key Decisions Summary:**
  - Canonical S3 path comes from metadata `s3_folder` (preserves spaces) to fix delete and related bugs.
  - Modularize `H3TM_Admin` via traits to reduce file size and improve maintainability.
  - Keep admin interactions via WP AJAX (and optionally REST) for minimal disruption.
  - Use polling of S3 `status.json` for progress (simple, robust) rather than introducing websockets.
  - Maintain URL history in the same table to enable 301 redirects without extra schema.
* **4.2. Alternatives Considered:**
  - Renaming S3 folders to slug format (dashes): rejected to avoid breaking existing content and Lambda conventions.
  - Full SPA admin rewrite (React/Vue): postponed; jQuery is sufficient for required UX improvements.
  - Dedicated status service (API Gateway + DynamoDB): more complex; S3 `status.json` suffices.
* **4.3. Known Risks & Mitigation:**
  - Browser/WordPress caching stale JS: version/enqueue assets with cache-busting; advise hard refresh.
  - Race conditions (rename/change URL vs. concurrent updates): enforce server-side checks and lock (per-tour mutex via transient if needed).
  - AWS credentials exposure: prefer env/wp-config constants; validate permissions; do not echo secrets.

## 5. Future Considerations

* **5.1. Potential Evolution:**
  - Migrate admin AJAX endpoints to WP REST API with nonce + capability middleware.
  - Adopt Composer with PSR-4 autoload; add unit tests (PHPUnit) for metadata and handlers.
  - TypeScript for admin JS; modular build (Vite/Rollup) while preserving WP enqueue patterns.
  - Optional push-based progress via API Gateway + SNS/Sockets for near real-time updates.
  - Metrics dashboard (CloudWatch + custom WP page) for processing throughput and errors.
* **5.2. Areas for Deeper Dive:**
  - IAM policy hardening (object-level prefixes; presign constraints).
  - CloudFront caching strategy (path-based TTL, invalidation batching).
  - Bulk actions performance and safe retries/idempotency design.

## 6. Glossary

* H3TM: H3 Tour Management plugin.
* S3 folder: Canonical S3 prefix under the bucket where a tour is stored (e.g., `tours/Jeffs Test/`).
* Slug: URL-safe path segment for a tour, e.g., `jeffs-test`.
* Status JSON: `status.json` object in S3 updated by Lambda with progress/percent/eta.
* Redirector: Component issuing 301 redirects from old slugs to the current slug using `url_history`.

