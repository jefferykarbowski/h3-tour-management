# System Architecture Blueprint: H3 Tour Management Plugin Revamp

**Version:** 1.0  
**Date:** 2025-10-09  
**Generated By:** OpenAI Codex CLI Assistant (GPT-4.1)

## 1. Introduction & Goals

* **1.1. Project Vision:**
  Deliver a stable, maintainable WordPress plugin to manage 3D tours stored on AWS S3 and delivered via CloudFront with Lambda-based processing. The revamp fixes critical defects (Delete, Change URL, Rename, Update/Get Script, Rebuild Metadata), refactors the codebase into modular traits for maintainability, and modernizes the admin UX (search/filter, bulk actions, progress, confirmations).

* **1.2. Key Objectives:**
  - Restore core features: Delete, Change URL (with redirect), Rename, Update, Get Script, Rebuild Metadata.
  - Use `metadata.s3_folder` as the single source of truth for all S3 paths.
  - Improve observability: robust logging across S3 operations and AJAX handlers.
  - Refactor `H3TM_Admin` into traits to reduce file size and improve cohesion.
  - Enhance admin UX: search/filter/sort, bulk actions, progress indicators, confirmations.
  - Maintain compatibility with WordPress 5.8+ and PHP 7.4+; prepare for PHP 8.x.
  - Preserve data integrity and URL history with correct redirects.

* **1.3. Scope:**
  - In scope: WordPress plugin code (PHP, JS, CSS), DB schema/table for tour metadata, AWS integrations (S3, CloudFront, Lambda), URL redirector behavior, logging/diagnostics, UI/UX improvements within WP Admin.
  - Out of scope: Replacing AWS with other cloud providers, large-scale Lambda redesign (beyond minor changes like writing status JSON), public theme development beyond redirects, multi-tenant auth beyond WP roles/capabilities.

* **1.4. Key Assumptions:**
  - WordPress ≥ 5.8 and PHP ≥ 7.4 are available; MySQL/MariaDB managed by WordPress.
  - AWS credentials/roles allow S3 read/write and CloudFront invalidation; Lambda already wired to ingest uploads and populate S3.
  - Lambda preserves spaces in S3 folder names and can optionally write a status file (JSON) to S3 for progress polling.
  - CloudFront distribution serves tours from `s3://bucket/tours/<display_name>/` and cache invalidation is acceptable post-update.

## 2. Architectural Drivers

* **2.1. Functional Requirements Summary:**
  - Deleting a tour removes metadata and S3 artifacts reliably using `s3_folder`.
  - Changing URL updates DB slug, maintains `url_history`, enforces 301 redirect, and refreshes UI + embed code.
  - Renaming tour updates display name only; URL/slug unchanged.
  - Update tour uploads new ZIP to S3, triggers Lambda, shows progress, invalidates CloudFront on completion.
  - Get Script provides accurate embed snippet reflecting current slug/CDN URL.
  - Rebuild Metadata reconstructs `wp_h3tm_tour_metadata` from S3 when needed.
  - Modern admin UX: search, filter, bulk actions, confirmation dialogs, progress feedback.

* **2.2. Non-Functional Requirements (NFRs):**
  - Maintainability: trait-based modularization, clear separation of concerns, logging.
  - Usability: streamlined UI with sensible action hierarchy and progress visibility.
  - Reliability: robust error handling, idempotent operations, defensive checks.
  - Performance: efficient S3 operations, minimal admin latency, CDN usage for delivery.
  - Security: capability checks, nonces in AJAX, sanitized inputs, least-privilege AWS access.
  - Observability: structured logs, correlation IDs, CloudWatch monitoring for Lambda.
  - Compatibility: WP 5.8+/PHP 7.4+ with a glide path to PHP 8.x.

* **2.3. Constraints & Preferences:**
  - Existing stack: WordPress, PHP, MySQL, AWS (S3/CloudFront/Lambda), jQuery.
  - Minimal infrastructure change; prioritize fixes and refactor within current ecosystem.
  - Preserve Lambda’s behavior (spaces in folder names) and adapt WP plugin accordingly.

## 3. Proposed Architecture

* **3.1. Architectural Style:**
  - Layered WordPress plugin (monolith) with clear module boundaries via PHP traits, integrated with a serverless pipeline (Lambda) for processing. Admin UI uses progressive enhancement (jQuery) with AJAX. Polling-based progress feedback via S3-hosted status JSON (optional Lambda enhancement) or WP-managed status when available.

* **3.2. Technology Stack Summary:**
  - Frontend: WordPress Admin UI, jQuery (existing), WP List Table and modals; optional small utility libraries (no framework migration).
  - Backend Language/Framework: PHP 7.4+ (WordPress plugin), WP AJAX hooks; prepare for PHP 8.x compatibility.
  - Database: MySQL table `wp_h3tm_tour_metadata` as specified (slug, display_name, s3_folder, url_history JSON, timestamps).
  - Messaging/Queues: None within WP; Lambda async processing triggered by S3 events; optional S3 status JSON for polling.
  - Cloud Platform/Services: AWS S3 (storage), CloudFront (CDN), Lambda (unzip/process); optional CloudFront invalidation.
  - Containerization/Orchestration: None for WP; Lambda functions packaged as zip (serverless).
  - Key Libraries/Tools: AWS SDK for PHP v3 (S3, CloudFront), WordPress nonces/capabilities, PSR-3-style logger (optional, else `error_log`), browser DevTools for debugging.

* **3.3. System Context Diagram (C4 Level 1):**
  - **Description:** Shows actors (Admin, Public Visitor), the H3TM plugin within the WordPress site, and external AWS services (S3, CloudFront, Lambda). It highlights admin interactions (manage tours) and public consumption (view tours via CDN), plus backend processing.
  - **Diagram (PlantUML):**
    ~~~plantuml
    @startuml
    !include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml

    Person(admin, "WP Admin", "Manages tours via WordPress admin")
    Person(visitor, "Public Visitor", "Views published tours via CDN")

    System_Boundary(h3tm_boundary, "H3 Tour Management Plugin") {
      System(h3tm, "H3TM Plugin", "WordPress plugin that manages tours, metadata, redirects, and S3/CloudFront integration")
    }

    System_Ext(s3, "Amazon S3", "Stores tour files and optional status JSON")
    System_Ext(cf, "Amazon CloudFront", "Delivers tour assets via CDN")
    System_Ext(lambda, "AWS Lambda", "Processes uploaded ZIPs to S3 (unzip, organize)")

    Rel(admin, h3tm, "Configures, uploads, updates, deletes tours", "HTTPS/WP Admin")
    Rel(visitor, cf, "Requests tour content", "HTTPS")
    Rel(h3tm, s3, "Upload/download, list, delete objects", "AWS SDK")
    Rel(h3tm, cf, "Invalidate cache (post-update)", "AWS SDK")
    Rel(lambda, s3, "Reads/writes tour folders; optional status JSON", "S3 Events")
    Rel(cf, s3, "Origin content fetch", "S3 origin")

    @enduml
    ~~~

* **3.4. Container Diagram (C4 Level 2):**
  - **Description:** Shows deployable units: WordPress (hosting the H3TM plugin), the Admin JS in the browser, the metadata table, and AWS services. Interactions include AJAX calls, DB CRUD, S3 operations, and CDN delivery.
  - **Diagram (PlantUML):**
    ~~~plantuml
    @startuml
    !include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

    Person(admin, "WP Admin", "Manages tours")
    Person(visitor, "Public Visitor", "Views tours")

    System_Boundary(h3tm_sys, "H3 Tour Management Plugin") {
      Container(wp, "WordPress + H3TM Plugin", "PHP 7.4+", "Admin pages, AJAX handlers, URL redirects, S3/CF clients")
      ContainerDb(db, "wp_h3tm_tour_metadata", "MySQL", "Tour slug, display name, s3_folder, url_history")
      Container(admin_js, "Admin JS", "JavaScript/jQuery", "Client-side handlers: modals, AJAX, progress UI")
    }

    System_Ext(s3, "Amazon S3", "Tour storage; optional status JSON")
    System_Ext(cf, "Amazon CloudFront", "CDN for tours")
    System_Ext(lambda, "AWS Lambda", "Processes uploads (unzip)")

    Rel(admin, admin_js, "Uses Admin UI", "HTTPS")
    Rel(admin_js, wp, "WP AJAX (admin-ajax.php?action=...)", "HTTPS/JSON")
    Rel(wp, db, "CRUD tour metadata", "SQL")
    Rel(wp, s3, "Upload/download/list/delete", "AWS SDK")
    Rel(wp, cf, "Invalidate paths after updates", "AWS SDK")
    Rel(lambda, s3, "Write processed assets + status", "S3")
    Rel(visitor, cf, "Requests tours", "HTTPS")
    Rel(cf, s3, "Origin fetch", "S3 origin")

    @enduml
    ~~~

* **3.5. Component Diagram(s) (C4 Level 3 - WordPress Plugin):**
  - **Description:** Details components within the H3TM WordPress plugin: Admin controller, AJAX handlers (split via traits), S3 service, metadata repository, redirector, page renderers, and JS modules.
  - **Diagram (PlantUML):**
    ~~~plantuml
    @startuml
    !include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

    Container(wp, "WordPress + H3TM Plugin", "PHP", "Runs inside WP runtime") {
      Component(admin_core, "H3TM_Admin (Core)", "PHP", "Registers menus, enqueues scripts, wires AJAX actions")
      Component(tr_tour, "Trait: Tour Handlers", "PHP", "Update, Get Script, Change URL, Rebuild Metadata")
      Component(tr_delren, "Trait: Delete & Rename", "PHP", "Delete tour, Rename tour")
      Component(tr_s3, "Trait: S3 Operations", "PHP", "Pre-signed URLs, upload processing, download/cleanup")
      Component(tr_mig, "Trait: Migration", "PHP", "Migrate to S3, directory upload, cleanup")
      Component(tr_pages, "Trait: Page Renderers", "PHP", "Render admin pages: main, email, analytics, S3 settings")
      Component(repo, "H3TM_Tour_Metadata", "PHP", "CRUD for wp_h3tm_tour_metadata; slug + s3_folder source of truth")
      Component(s3svc, "H3TM_S3_Simple", "PHP", "S3 deletes, uploads, folder ops; uses metadata.s3_folder")
      Component(redirector, "H3TM_URL_Redirector", "PHP", "301 redirects using url_history on template_redirect")
      Component(logger, "Logging", "PHP", "Plugin-scoped logging; error_log or PSR-3")
    }

    Component(admin_js, "Admin JS (admin.js, admin-tour-features.js)", "JS/jQuery", "Event delegation, modals, AJAX, progress polling")
    Database(db, "wp_h3tm_tour_metadata", "MySQL")
    System_Ext(s3, "Amazon S3", "Object storage")
    System_Ext(cf, "Amazon CloudFront", "CDN")
    System_Ext(lambda, "AWS Lambda", "Processing pipeline")

    Rel(admin_js, admin_core, "AJAX actions (nonce/capability)")
    Rel(admin_core, tr_tour, "uses")
    Rel(admin_core, tr_delren, "uses")
    Rel(admin_core, tr_s3, "uses")
    Rel(admin_core, tr_mig, "uses")
    Rel(admin_core, tr_pages, "uses")
    Rel(tr_tour, repo, "CRUD metadata")
    Rel(tr_delren, repo, "CRUD metadata")
    Rel(tr_s3, s3svc, "S3 ops")
    Rel(s3svc, s3, "S3 operations via AWS SDK")
    Rel(tr_tour, cf, "Invalidate post-update", "AWS SDK")
    Rel(redirector, repo, "Reads slug + url_history to redirect")
    Rel(repo, db, "Read/Write tour data")
    Rel(lambda, s3, "Writes processed content/status")
    Rel(admin_js, s3, "Direct upload (optional pre-signed)")

    @enduml
    ~~~

* **3.6. Data Model Overview & ERD:**
  - **Description:** The plugin uses a dedicated table `wp_h3tm_tour_metadata` to store tour slugs, display names (human-readable), canonical S3 folder path (with spaces preserved), URL history (JSON array of old slugs), and timestamps. The `s3_folder` is the source of truth for S3 paths; all S3 operations derive from it. Redirects use `url_history` to 301 old slugs to the latest slug.
  - **Key Entities:**
    - TourMetadata: `id`, `tour_slug` (unique), `display_name`, `s3_folder` (preserve spaces), `url_history` (JSON), `created_date`, `updated_date`.
  - **Diagram (PlantUML ERD):**
    ~~~plantuml
    @startuml
    hide circle

    entity "wp_h3tm_tour_metadata" as TourMetadata {
      * id : bigint <<PK>>
      --
      tour_slug : varchar <<UNIQUE>>
      display_name : varchar
      s3_folder : varchar
      url_history : text  \n(JSON array of old slugs)
      created_date : datetime
      updated_date : datetime
    }

    @enduml
    ~~~

* **3.7. API Design & Communication:**
  - **API Style:** WordPress AJAX via `admin-ajax.php` with actions and nonces. Synchronous request/response for admin actions; asynchronous processing via Lambda, with progress polling (AJAX) against an S3 status JSON or a WP-managed status endpoint when available.
  - **Communication Patterns:**
    - Admin JS → WP Plugin: Synchronous AJAX (JSON responses), secured with nonces and capability checks.
    - WP Plugin ↔ AWS: Synchronous SDK calls (S3 CRUD, CloudFront invalidation); Lambda is event-driven by S3.
    - Progress: Periodic polling from Admin JS to an endpoint that reads S3 status JSON (if enabled) or polls internal state.
  - **Key AJAX Actions (examples):** `h3tm_delete_tour`, `h3tm_change_tour_url`, `h3tm_rename_tour`, `h3tm_update_tour`, `h3tm_get_embed_script`, `h3tm_rebuild_metadata`.
  - **Key Interaction Flow (Sequence Diagram – Change URL):**
    - **Description:** Admin changes a tour slug. Plugin validates, updates DB, appends old slug to `url_history`, ensures redirector recognizes new mapping, and refreshes UI and embed code.
    - **Diagram (PlantUML):**
      ~~~plantuml
      @startuml
      actor Admin
      participant "Admin JS" as JS
      participant "WP AJAX (H3TM)" as WP
      database "Metadata DB" as DB
      participant "Redirector" as RED

      Admin -> JS : Clicks "Change URL", enters new slug
      JS -> WP : POST admin-ajax.php?action=h3tm_change_tour_url (nonce, id, new_slug)
      WP -> DB : Validate uniqueness; update tour_slug; push old slug -> url_history
      DB --> WP : Update OK
      WP -> RED : Ensure redirector cache/hooks ready (template_redirect)
      WP --> JS : { success: true, new_slug, embedUrl }
      JS -> JS : Refresh table row + embed snippet

      == Later ==
      Admin -> RED : Request old /tour/old-slug/
      RED -> DB : Lookup old slug in url_history
      DB --> RED : Mapping -> new slug
      RED --> Admin : 301 Location: /tour/new-slug/
      @enduml
      ~~~

* **3.8. Cross-Cutting Concerns:**
  - **Authentication & Authorization:** Use WordPress capabilities (e.g., `manage_options` or a custom capability) and nonces for all AJAX actions. Only authorized admins can perform tour operations. Validate inputs and sanitize output.
  - **Logging & Monitoring:** Centralize logging with a plugin logger prefix (e.g., `[H3TM]`). Log S3 paths from `metadata.s3_folder`, key milestones (start/complete/fail), and errors. Log AJAX action entry/exit with correlation IDs. Use CloudWatch for Lambda metrics. Optionally integrate WP-CLI commands for diagnostics.
  - **Security Considerations:** Sanitize and validate slugs/names; enforce nonce and capability checks; use prepared statements via WPDB or sanitized ORM wrappers; store AWS credentials securely (prefer instance roles/Env vars, never commit secrets); HTTPS everywhere; limited IAM permissions for S3/CF.
  - **Scalability & Performance:** Stateless plugin operations; S3/CloudFront scale automatically; batch/bulk actions processed sequentially with progress UI; avoid heavy synchronous S3 traversals on the admin request path; employ pagination for tour tables.
  - **Reliability & Availability:** Defensive checks before S3 delete; idempotent handlers; retry-safe CloudFront invalidations; maintain URL history for robust redirects; graceful degradation if S3 status JSON is absent (UI falls back to generic “Processing…” state).

* **3.9. Deployment View:**
  - **Target Environment:** WordPress hosting (e.g., EC2/Lightsail, managed WP) with PHP 7.4+; AWS us-east-1 (or chosen region) hosting S3/CloudFront/Lambda.
  - **Deployment Strategy:** Standard WP plugin deployment; Lambda packaged and deployed via zip or SAM/Serverless; S3 bucket configured with proper policies; CloudFront distribution points to S3 origin. No containers required.
  - **Deployment Diagram (PlantUML):**
    ~~~plantuml
    @startuml
    !include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Deployment.puml

    DeploymentNode(admin_client, "Admin Browser", "Chrome/Firefox") {
      DeploymentNode(admin_ui, "WP Admin UI", "HTTPS") {
        artifact(admin_js, "Admin JS (jQuery)")
      }
    }

    DeploymentNode(wp_host, "WordPress Host", "Apache/Nginx + PHP-FPM") {
      container(wp_plugin, "H3TM Plugin (PHP)", "WordPress")
      database(db, "MySQL", "wp_h3tm_tour_metadata")
    }

    DeploymentNode(aws, "AWS Region", "us-east-1") {
      node(s3, "Amazon S3", "Bucket: tours")
      node(cf, "Amazon CloudFront", "CDN Distribution")
      node(lambda, "AWS Lambda", "Processor Function")
    }

    Rel(admin_js, wp_plugin, "AJAX actions", "HTTPS")
    Rel(wp_plugin, db, "CRUD", "SQL")
    Rel(wp_plugin, s3, "S3 operations", "AWS SDK")
    Rel(wp_plugin, cf, "Invalidate paths", "AWS SDK")
    Rel(lambda, s3, "Write processed assets/status", "S3 API")
    Rel(cf, s3, "Origin fetch", "S3 origin")
    @enduml
    ~~~

## 4. Design Rationale & Trade-offs

* **4.1. Key Decisions Summary:**
  - Use `metadata.s3_folder` as authoritative S3 key path to resolve Delete bug and ensure consistency across S3 operations.
  - Split `H3TM_Admin` into focused traits to improve maintainability and reduce merge/syntax errors.
  - Keep jQuery-based admin UI but correct hoisting and event delegation issues; add logging and console instrumentation to debug.
  - Favor polling (AJAX) for progress using S3 status JSON to avoid new real-time infrastructure.
  - Maintain URL history and centralized redirector to ensure SEO-preserving 301 behavior after slug changes.

* **4.2. Alternatives Considered:**
  - Migrating to a React-based WP admin: higher effort, unnecessary for short-term fixes; retained jQuery with improved structure.
  - Introducing a custom backend service for progress: increases operational overhead; instead, use S3 status JSON and polling.
  - Normalizing S3 folders to dashed names: conflicts with current Lambda behavior and legacy data; chose to align WordPress with Lambda (preserve spaces).

* **4.3. Known Risks & Mitigation:**
  - Risk: Browser/WordPress caching stale JS. Mitigation: cache-busting via `wp_enqueue_script` versioning; instruct hard refresh.
  - Risk: Race conditions during slug change under concurrency. Mitigation: unique index on `tour_slug`, atomic DB update with retries.
  - Risk: CloudFront invalidation costs/limits. Mitigation: batch and minimize invalidation paths; invalidate on completion only.
  - Risk: PHP 7.4 deprecations on newer hosts. Mitigation: test on PHP 8.x and fix notices; adopt compatible code patterns.

## 5. Future Considerations

* **5.1. Potential Evolution:**
  - Migrate AJAX endpoints to WP REST API with structured JSON schemas.
  - Upgrade minimum runtime to PHP 8.1+, adopt typed properties and enums where applicable.
  - Replace polling with WebSocket (API Gateway WebSockets) or SNS push for real-time updates.
  - Add unit/integration tests (PHPUnit) and JS tests; wire CI.
  - Support multi-bucket/multi-tenant deployments with IAM role switching.

* **5.2. Areas for Deeper Dive:**
  - Detailed CloudFront invalidation strategy (path granularity, batching).
  - Lambda pipeline enhancements (status JSON schema, error codes, retries).
  - Advanced analytics (view counts, performance metrics) and admin dashboards.

## 6. Glossary

* H3TM: H3 Tour Management plugin.
* S3 Folder: The canonical path to a tour’s directory in S3; must preserve spaces and exactly match Lambda’s folder names.
* Slug: URL-friendly identifier for a tour; may differ from display name.
* URL History: JSON array tracking previous slugs to support 301 redirects.
* CDN: Content Delivery Network, here Amazon CloudFront, for fast asset delivery.

---

# Implementation Notes Tied to Requirements

The following actionable notes map the architecture to concrete fixes and refactors.

## Critical Bug Fixes (Phase 1)

1) Delete Tour – use metadata.s3_folder everywhere
- Replace any derivation like `sanitize_title($tour_name)` with lookup from `H3TM_Tour_Metadata`:
  - Fetch tour by display name or id; use `$tour->s3_folder` (strip leading `tours/` and trailing `/` as needed for APIs).
- Add verbose logging in `H3TM_S3_Simple::archive_tour()` and related delete paths with the exact S3 key prefix.
- Test with names containing spaces, hyphens, multiple spaces, special characters.

2) Change URL – make AJAX path functional end-to-end
- Verify action registered in `H3TM_Admin::__construct` (`wp_ajax_h3tm_change_tour_url`).
- Ensure handler callable and updates DB via `H3TM_Tour_Metadata::change_slug()`; append old slug to `url_history`.
- Initialize `H3TM_URL_Redirector` on `template_redirect` so old URLs 301 to the new slug.
- On success, Admin JS refreshes table row and embed URL; log success with old/new slugs.

3) Rename Tour – ensure UI and handler work
- Use event delegation for `.rename-tour`; add console logs to confirm handler firing.
- Generate and display modal correctly; call `handle_rename_tour()` via AJAX; refresh table.

4) Update Tour & Get Script – fix hoisting and loading
- Ensure `admin-tour-features.js` is enqueued and cache-busted.
- Convert function expressions to declarations or move definitions before usage; add console logs.
- Verify Update flow triggers Lambda and progress is visible (poll, then invalidate CloudFront on completion).

5) Rebuild Metadata – register AJAX and instrument
- Confirm `wp_ajax_h3tm_rebuild_metadata` registered; add logging in handler.
- Provide a console snippet for manual testing; confirm server-side logs on invocation.

## Refactor to Traits (Phase 2)

Proposed structure under `includes/traits/` with `H3TM_Admin` using these traits:
- `trait-h3tm-tour-handlers.php`: `handle_update_tour()`, `handle_get_embed_script()`, `handle_change_tour_url()`, `handle_rebuild_metadata()`
- `trait-h3tm-delete-rename.php`: `handle_delete_tour()`, `handle_rename_tour()`
- `trait-h3tm-s3-operations.php`: `handle_get_s3_presigned_url()`, `handle_process_s3_upload()`, `download_from_s3()`, `cleanup_s3_file()`
- `trait-h3tm-migration.php`: `handle_migrate_tour_to_s3()`, `upload_directory_to_s3()`, `delete_directory()`
- `trait-h3tm-page-renderers.php`: `render_main_page()`, `render_email_settings_page()`, `render_analytics_page()`, `render_s3_settings_page()`

Implementation checklist:
- Create `includes/traits/` and extract methods one trait at a time; add `use TraitName;` in `H3TM_Admin`.
- After each extraction, validate PHP syntax and test affected features.
- Keep each trait under ~300 lines; main class under ~400 lines.

## UX Improvements (Phase 3)

- Tour Table: search box, filter dropdown, bulk selection/actions; emphasize primary actions (Preview), secondary (Embed/Change URL), tertiary in a More menu.
- Real-time progress: poll a status JSON (e.g., `tours/<Display Name>/.status.json`) written by Lambda; show % complete, ETA, auto-refresh on completion.
- Confirmation dialogs: Delete/Archive/Change URL with clear messaging and irreversible warnings.

## Testing & Validation

- Syntax checks: `php -l` on PHP files; JS lint or Node syntax checks.
- Browser DevTools: validate no JS errors, correct AJAX requests, and responses.
- Database verification: query `wp_h3tm_tour_metadata`, ensure `s3_folder` preserves spaces and `url_history` is valid JSON.
- End-to-end scenarios for Delete, Change URL, Rename, Update, and Get Script, including CloudFront invalidation post-update.

